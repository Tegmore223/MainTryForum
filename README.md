# OP.WEB

OP.WEB — автономный ретро-форум с анонимным общением, реализованный без внешних зависимостей для совместимости с изолированной средой. Проект написан на Node.js (CommonJS) и включает полноценный фронтенд в духе форумов начала 2000‑х.

## Возможности

- Регистрация по никнейму и паролю (с одноразовой капчей), опциональный e-mail для восстановления.
- Авторизация по JWT, хранение IP, смена никнейма и темы оформления, запрет на дубли никнеймов.
- Разделы форума, треды с вложенными ответами, лайками, благодарностями и избранным.
- Главная страница акцентирует разделы, треды показывают ID, автора, счётчик просмотров и кнопку жалобы; шапка поддерживает собственный PNG-логотип.
- Профиль со статистикой, значками активности, темами (светлая/тёмная), быстрым доступом к лайкам/избранному и загрузкой аватарки.
- Личные сообщения с отдельной панелью, непрочитанными статусами и быстрыми ответами.
- Админ-панель с двумя способами входа: `tegmore/public242` и резервный `tegmore/personal242273`.
- Управление разделами, ролями, банами по IP и аккаунту, логирование действий, экспорт пользователей, архив тредов.
- Интерактивные графики и таблицы в админке: обзор статистики, топ-разделы, лог событий, выгрузка пользователей без паролей и реестр банов с разблокировкой.
- Двухфакторная аутентификация для администраторов с отправкой одноразового кода на e-mail и резервной отменой.
- Авторизация по JWT, хранение IP, смена никнейма и темы оформления.
- Разделы форума, треды с вложенными ответами, лайками, благодарностями и избранным.
- Главная страница акцентирует разделы, треды показывают ID, автора и счётчик просмотров, на каждом есть кнопка жалобы.
- Профиль со статистикой, значками активности, темами (светлая/тёмная), пиксельными элементами интерфейса, быстрым доступом к лайкам и избранному.
- Админ-панель с двумя способами входа: `tegmore/public242` и резервный `tegmore/personal242273`.
- Управление разделами, ролями, банами по IP и аккаунту, логирование действий, экспорт пользователей, архив тредов.
- Интерактивные графики и таблицы в админке: обзор статистики за неделю, топ-разделы, лог событий и выгрузка пользователей в таблице.
- Модераторский кабинет с обработкой жалоб и временными банами.
- Система жалоб на треды и ответы, обращения сразу попадают в кабинеты модераторов и администраторов.
- Настройка оформления через админку: загрузка PNG-логотипа, изменение названия форума, адаптивное профил-окно.
- Современный адаптивный интерфейс с мобильной версией онбординга и переключателем темы-тумблером (тёмная тема по умолчанию).
- Серверное кеширование, фоновые очереди, сжатие статики (gzip/brotli), ленивые загрузки, пагинация.
- Безопасность: собственный rate limiting, PBKDF2-хеширование паролей, строгие HTTP-заголовки, фильтрация загрузок изображений и проверка MIME-типа, шифрование базы данных AES-256-GCM и защита от самостоятельного повышения ролей.
- Безопасность: собственный rate limiting, PBKDF2-хеширование паролей, строгие HTTP-заголовки, фильтрация загрузок изображений и проверка MIME-типа.

## Структура

```
src/
  server.js                – основной HTTP-сервер
  config.js                – глобальные настройки
  services/                – бизнес-логика (пользователи, треды, модерация, очередь, кеш, изображения)
  utils/                   – генераторы ID, криптография, работа с хранилищем и HTTP
public/
  index.html               – форум с ретро-дизайном
  admin.html, moderator.html – отдельные панели
  styles.css, app.js       – UI и логика клиента
  admin.js, moderator.js   – инструменты администратора/модератора
```

Данные хранятся в `data/database.json`, действия администрации логируются в `logs/admin.log`, аватары попадают в `public/assets/avatars`.

## Запуск

```
npm install # не требуется, зависимостей нет
npm start
```

Сервер запускается на порту `4000` (изменяется через `PORT`). Фронтенд доступен на `http://localhost:4000/`.

### 2FA и почта

Для доставки одноразовых кодов администраторам настройте SMTP-переменные окружения:

```
EMAIL_HOST=smtp.example.com
EMAIL_PORT=465
EMAIL_SECURE=true # установите false для нешифрованного соединения
EMAIL_USER=bot@example.com
EMAIL_PASSWORD=secret
EMAIL_FROM="OP.WEB <bot@example.com>"
ADMIN_ALERT_EMAIL=security@example.com
```

Если SMTP не указан, коды выводятся в логах сервера, но в продакшене рекомендуется настроить реальный почтовый шлюз. Админ по умолчанию привязан к адресу `security@opweb.local`, чтобы 2FA работала сразу после развёртывания.

## Безопасность и производительность

- Все тяжёлые операции (например, обработка изображений) отправляются в внутреннюю очередь и выполняются асинхронно.
- Реализованы кеширование разделов и тредов, периодическая очистка капчи и банов, gzip/brotli компрессия ответов.
- Встроенные ограничения размера изображений (400 КБ), строгая проверка MIME и хранение только безопасных форматов.
- Rate limiting по IP, строгие заголовки безопасности, фильтрация контента и контрольная запись всех действий администрации.
- Файл `data/database.json` хранится в виде шифротекста (AES-256-GCM) и дешифруется только внутри приложения.

## Темы и оформление

Интерфейс использует зелёную палитру, пиксельные кнопки и шрифты, вдохновлённые форумами начала 2000‑х. Доступны светлая и тёмная темы, переключатель расположен в правом верхнем углу.

## Роли

- **Пользователь**: создание тредов, ответы, жалобы, лайки/благодарности/избранное.
- **Модератор**: просмотр жалоб, блокировка тредов, временные баны.
- **Админ**: все возможности модератора + создание разделов, назначение ролей, глобальные баны, архивы, статистика и логи.

## Дополнительно

- Архив недоступен пользователям, но хранится в `archivedThreads` для администраторов.
- Экспорт пользователей содержит никнейм, ID, e-mail и IP и доступен в таблице админки без отображения паролей.
- Резервные входы администратора задокументированы и работают через те же формы авторизации.
- Жалобы отображают ID обращения и ник отправителя, а также выдержку из спорного сообщения для удобной модерации.
